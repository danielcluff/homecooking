---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Edit Category">
	<div class="max-w-xl mx-auto">
		<div class="md:flex md:items-center md:justify-between">
			<div>
				<h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl">Edit Category</h2>
				<p class="mt-1 text-sm text-gray-500">Update category details.</p>
			</div>
		</div>

		<div id="loading" class="mt-8 text-center text-gray-500">
			Loading category...
		</div>

		<div id="error" class="mt-8 hidden">
			<div class="bg-red-50 border border-red-200 rounded-md p-4">
				<p class="text-red-800" id="error-message"></p>
			</div>
		</div>

		<form id="category-form" class="mt-8 space-y-6 hidden">
			<div class="bg-white shadow sm:rounded-lg">
				<div class="px-4 py-5 sm:p-6">
					<div class="space-y-4">
						<div>
							<label for="name" class="block text-sm font-medium text-gray-700">Name <span class="text-red-500">*</span></label>
							<input
								type="text"
								name="name"
								id="name"
								required
								class="mt-1 block w-full rounded-md border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="e.g., Breakfast"
							/>
						</div>

						<div>
							<label for="icon" class="block text-sm font-medium text-gray-700">Icon (emoji)</label>
							<input
								type="text"
								name="icon"
								id="icon"
								class="mt-1 block w-full rounded-md border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="e.g., ðŸ³"
							/>
						</div>

						<div>
							<label for="description" class="block text-sm font-medium text-gray-700">Description</label>
							<textarea
								id="description"
								name="description"
								rows="3"
								class="mt-1 block w-full rounded-md border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="Brief description of this category"
							/>
						</div>

						<div>
							<label for="order_index" class="block text-sm font-medium text-gray-700">Order</label>
							<input
								type="number"
								name="order_index"
								id="order_index"
								min="0"
								class="mt-1 block w-full rounded-md border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
							/>
							<p class="mt-1 text-xs text-gray-500">Lower numbers appear first in list</p>
						</div>
					</div>
				</div>

				<div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row sm:items-center sm:justify-between">
					<button
						type="button"
						id="delete-btn"
						class="inline-flex justify-center rounded-md border border-transparent bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
					>
						Delete Category
					</button>
				</div>
			</div>

			<div class="flex items-center justify-end gap-x-6 pt-5">
				<a href="/admin/categories" class="text-sm font-medium text-gray-900 hover:text-orange-600">Cancel</a>
				<button
					type="submit"
					class="inline-flex justify-center rounded-md border border-transparent bg-orange-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2"
				>
					Update Category
				</button>
			</div>
		</form>
	</div>

	<script>
		const urlParams = new URLSearchParams(window.location.search);
		const categoryId = urlParams.get('id');

		async function loadCategory() {
			if (!categoryId) {
				showError('Category ID not provided');
				return;
			}

			try {
				const response = await fetch(`http://localhost:8080/api/v1/categories/${categoryId}`);
				if (!response.ok) {
					throw new Error('Failed to load category');
				}
				const category = await response.json();

				document.getElementById('name').value = category.name || '';
				document.getElementById('icon').value = category.icon || '';
				document.getElementById('description').value = category.description || '';
				document.getElementById('order_index').value = category.order_index || 0;

				document.getElementById('loading').classList.add('hidden');
				document.getElementById('category-form').classList.remove('hidden');
			} catch (error) {
				showError(error.message);
			}
		}

		function showError(message) {
			document.getElementById('loading').classList.add('hidden');
			document.getElementById('error-message').textContent = message;
			document.getElementById('error').classList.remove('hidden');
		}

		document.getElementById('category-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(e.target);
			const data = {
				name: formData.get('name'),
				icon: formData.get('icon') || null,
				description: formData.get('description') || null,
				order_index: formData.get('order_index') ? parseInt(formData.get('order_index') as string) : 0,
			};

			try {
				const response = await fetch(`http://localhost:8080/api/v1/categories/${categoryId}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
					},
					body: JSON.stringify(data),
				});

				if (!response.ok) {
					throw new Error('Failed to update category');
				}

				window.location.href = '/admin/categories';
			} catch (error) {
				showError(error.message);
			}
		});

		document.getElementById('delete-btn').addEventListener('click', async () => {
			if (!confirm('Are you sure you want to delete this category?')) {
				return;
			}

			try {
				const response = await fetch(`http://localhost:8080/api/v1/categories/${categoryId}`, {
					method: 'DELETE',
					headers: {
						'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
					},
				});

				if (!response.ok) {
					throw new Error('Failed to delete category');
				}

				window.location.href = '/admin/categories';
			} catch (error) {
				showError(error.message);
			}
		});

		loadCategory();
	</script>
</AdminLayout>
