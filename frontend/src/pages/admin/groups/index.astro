---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Recipe Groups">
	<div class="sm:flex sm:items-center">
		<div class="sm:flex-auto">
			<h1 class="text-2xl font-semibold leading-6 text-gray-900">Recipe Groups</h1>
			<p class="mt-2 text-sm text-gray-700">
				Organize recipes that belong together (e.g., "Biscuits & Gravy").
			</p>
		</div>
		<div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
			<a
				href="/admin/groups/new"
				class="block rounded-md bg-orange-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-orange-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600"
			>
				Create Group
			</a>
		</div>
	</div>

	<div id="loading" class="mt-8 text-center text-gray-500 py-12">
		Loading groups...
	</div>

	<div id="error" class="mt-8 hidden">
		<div class="bg-red-50 border border-red-200 rounded-md p-4">
			<p class="text-red-800" id="error-message"></p>
		</div>
	</div>

	<div id="groups-container" class="mt-8 hidden">
		<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
		</div>
	</div>

	<div id="empty-state" class="mt-8 hidden">
		<p class="text-center text-gray-500 py-12">
			No recipe groups yet. <a href="/admin/groups/new" class="text-orange-600 hover:text-orange-700">Create your first group!</a>
		</p>
	</div>
</AdminLayout>

<script>
	async function loadGroups() {
		try {
			const response = await fetch('http://localhost:8080/api/v1/groups');
			if (!response.ok) {
				throw new Error('Failed to load groups');
			}
			const data = await response.json();
			const groups = data.groups || [];

			document.getElementById('loading').classList.add('hidden');

			if (groups.length === 0) {
				document.getElementById('empty-state').classList.remove('hidden');
				return;
			}

			const groupsContainer = document.getElementById('groups-container');
			groupsContainer.innerHTML = groups.map((group: any) => `
				<div class="bg-white shadow-sm border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
					<div class="flex items-start justify-between">
						<div class="flex-1">
							<div class="flex items-center gap-3">
								<span class="text-3xl">${group.icon || 'üçΩÔ∏è'}</span>
								<h3 class="text-lg font-semibold text-gray-900">${group.name}</h3>
							</div>
							<p class="mt-2 text-sm text-gray-600 line-clamp-2">
								${group.description || 'No description'}
							</p>
						</div>
					</div>
					<div class="mt-4 pt-4 border-t border-gray-100 flex justify-end gap-3">
						<a href="/admin/groups/edit?id=${group.id}" class="text-sm font-medium text-orange-600 hover:text-orange-700">
							Edit
						</a>
						<button onclick="deleteGroup('${group.id}')" class="text-sm font-medium text-red-600 hover:text-red-700">
							Delete
						</button>
					</div>
				</div>
			`).join('');

			document.getElementById('groups-container').classList.remove('hidden');
		} catch (error: any) {
			document.getElementById('loading').classList.add('hidden');
			document.getElementById('error-message').textContent = error.message;
			document.getElementById('error').classList.remove('hidden');
		}
	}

	async function deleteGroup(id: string) {
		if (!confirm('Are you sure you want to delete this group?')) {
			return;
		}

		try {
			const response = await fetch(`http://localhost:8080/api/v1/groups/${id}`, {
				method: 'DELETE',
				headers: {
					'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
				},
			});

			if (!response.ok) {
				throw new Error('Failed to delete group');
			}

			loadGroups();
		} catch (error: any) {
			alert(error.message);
		}
	}

	(window as any).deleteGroup = deleteGroup;
	loadGroups();
</script>
