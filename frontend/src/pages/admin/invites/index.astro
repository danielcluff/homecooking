---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { apiFetch } from '../../../lib/api';

const { user } = Astro.locals;
if (!user) {
	return Astro.redirect('/login');
}

const invites = await apiFetch('/api/v1/invites', true);
---

<AdminLayout title="User Invites">
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<div class="flex justify-between items-center mb-6">
			<div>
				<h1 class="text-2xl font-bold text-gray-900">User Invites</h1>
				<p class="mt-1 text-sm text-gray-500">Invite users to join your HomeCooking instance</p>
			</div>
		</div>

		<div class="mb-6">
			<form id="invite-form" class="bg-white shadow rounded-lg p-6">
				<div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
					<div class="sm:col-span-4">
						<label for="email" class="block text-sm font-medium text-gray-700">
							Email
						</label>
						<input
							type="email"
							name="email"
							id="email"
							required
							class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
						/>
					</div>
					<div class="sm:col-span-2">
						<label for="role" class="block text-sm font-medium text-gray-700">
							Role
						</label>
						<select
							name="role"
							id="role"
							class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
						>
							<option value="user">User</option>
							<option value="admin">Admin</option>
						</select>
					</div>
					<div class="sm:col-span-3">
						<label for="expires_at" class="block text-sm font-medium text-gray-700">
							Expires At (Optional)
						</label>
						<input
							type="datetime-local"
							name="expires_at"
							id="expires_at"
							class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm"
						/>
					</div>
				</div>
				<div class="mt-6">
					<button
						type="submit"
						class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500"
					>
						Create Invite
					</button>
				</div>
			</form>
		</div>

		{invites && invites.length > 0 ? (
			<div class="bg-white shadow rounded-lg overflow-hidden">
				<ul class="divide-y divide-gray-200">
					{invites.map((invite) => (
						<li class="px-4 py-4 sm:px-6">
							<div class="flex items-center justify-between">
								<div>
									<p class="text-sm font-medium text-orange-600 truncate">{invite.code}</p>
									<p class="mt-1 flex items-center text-sm text-gray-500">
										{invite.email ? (
											<span>{invite.email}</span>
										) : (
											<span>No email specified</span>
										)}
										<span class="mx-4">|</span>
										<span>Role: {invite.role}</span>
										{invite.expires_at ? (
											<>
												<span class="mx-4">|</span>
												<span>Expires: {new Date(invite.expires_at).toLocaleDateString()}</span>
											</>
										) : (
											<>
												<span class="mx-4">|</span>
												<span>Never expires</span>
											</>
										)}
										{invite.used_at ? (
											<>
												<span class="mx-4">|</span>
												<span class="text-green-600">Used</span>
											</>
										) : (
											<>
												<span class="mx-4">|</span>
												<span class="text-blue-600">Pending</span>
											</>
										)}
									</p>
								</div>
								{!invite.used_at && (
									<button
										data-id={invite.id}
										data-action="delete-invite"
										class="text-red-600 hover:text-red-900 text-sm font-medium"
									>
										Delete
									</button>
								)}
							</div>
						</li>
					))}
				</ul>
			</div>
		) : (
			<div class="text-center py-12">
				<p class="text-gray-500">No invites found</p>
				<p class="mt-2 text-sm text-gray-400">Create an invite to add users to your instance</p>
			</div>
		)}
	</div>

	<script>
		document.getElementById('invite-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const token = localStorage.getItem('token');
			const formData = new FormData(e.target);
			const body = {
				email: formData.get('email'),
				role: formData.get('role') || 'user'
			};

			const expiresAt = formData.get('expires_at');
			if (expiresAt) {
				body.expires_at = new Date(expiresAt).toISOString();
			}

			try {
				const res = await fetch('/api/v1/invites', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${token}`
					},
					body: JSON.stringify(body)
				});
				if (res.ok) {
					window.location.reload();
				} else {
					const data = await res.json();
					alert(data.error || 'Failed to create invite');
				}
			} catch (err) {
				alert('Error creating invite');
			}
		});

		document.querySelectorAll('[data-action="delete-invite"]').forEach((btn) => {
			btn.addEventListener('click', async (e) => {
				e.preventDefault();
				if (!confirm('Are you sure you want to delete this invite?')) return;

				const id = e.target.getAttribute('data-id');
				const token = localStorage.getItem('token');
				try {
					const res = await fetch(`/api/v1/invites/${id}`, {
						method: 'DELETE',
						headers: {
							'Authorization': `Bearer ${token}`
						}
					});
					if (res.ok) {
						window.location.reload();
					} else {
						alert('Failed to delete invite');
					}
				} catch (err) {
					alert('Error deleting invite');
				}
			});
		});
	</script>
</AdminLayout>
