---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Create Recipe">
	<div class="max-w-3xl mx-auto">
		<div class="md:flex md:items-center md:justify-between">
			<div>
				<h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">Create Recipe</h2>
				<p class="mt-1 text-sm text-gray-500">Add a new recipe to your collection.</p>
			</div>
		</div>

		<form id="recipe-form" class="mt-8 space-y-6">
			<div class="bg-white shadow sm:rounded-lg">
				<div class="px-4 py-5 sm:p-6">
					<div class="md:grid md:grid-cols-2 md:gap-6">
						<div class="col-span-2">
							<label for="title" class="block text-sm font-medium text-gray-700">Title <span class="text-red-500">*</span></label>
							<input
								type="text"
								name="title"
								id="title"
								required
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="Recipe title"
							/>
						</div>

						<div class="col-span-2">
							<label for="description" class="block text-sm font-medium text-gray-700">Description</label>
							<textarea
								id="description"
								name="description"
								rows="2"
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="Brief description"
							/>
						</div>

						<div>
							<label for="category_id" class="block text-sm font-medium text-gray-700">Category</label>
							<select
								id="category_id"
								name="category_id"
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
							>
								<option value="">No category</option>
							</select>
						</div>

						<div>
							<label for="groups" class="block text-sm font-medium text-gray-700">Groups</label>
							<select
								id="groups"
								name="groups"
								multiple
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm h-24"
							>
								<option value="" disabled>Select groups (Ctrl/Cmd+click for multiple)</option>
							</select>
							<p class="mt-1 text-xs text-gray-500">Hold Ctrl/Cmd to select multiple groups</p>
						</div>

						<div>
							<label for="servings" class="block text-sm font-medium text-gray-700">Servings</label>
							<input
								type="number"
								name="servings"
								id="servings"
								min="1"
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="4"
							/>
						</div>

						<div>
							<label for="prep_time_minutes" class="block text-sm font-medium text-gray-700">Prep Time (min)</label>
							<input
								type="number"
								name="prep_time_minutes"
								id="prep_time_minutes"
								min="0"
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="10"
							/>
						</div>

						<div>
							<label for="cook_time_minutes" class="block text-sm font-medium text-gray-700">Cook Time (min)</label>
							<input
								type="number"
								name="cook_time_minutes"
								id="cook_time_minutes"
								min="0"
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
								placeholder="20"
							/>
						</div>

						<div>
							<label for="difficulty" class="block text-sm font-medium text-gray-700">Difficulty</label>
							<select
								id="difficulty"
								name="difficulty"
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm"
							>
								<option value="">Not specified</option>
								<option value="easy">Easy</option>
								<option value="medium">Medium</option>
								<option value="hard">Hard</option>
							</select>
						</div>

						<div class="col-span-2">
							<label class="block text-sm font-medium text-gray-700 mb-2">Featured Image</label>
							<div class="mt-1 flex items-center gap-4">
								<div class="flex-1">
									<label for="image_file" class="block text-sm text-gray-700 mb-1">Upload Image</label>
									<input
										type="file"
										id="image_file"
										accept="image/jpeg,image/png,image/gif,image/webp"
										class="block w-full text-sm text-gray-700 file:mr-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"
									/>
								</div>
								<div id="image_preview" class="hidden w-32 h-32 bg-gray-100 rounded-lg overflow-hidden">
									<img id="preview_img" src="" alt="Preview" class="w-full h-full object-cover" />
								</div>
							</div>
							<input type="hidden" name="featured_image_path" id="featured_image_path" />
						</div>

						<div class="col-span-2">
							<label for="markdown_content" class="block text-sm font-medium text-gray-700">Recipe Content (Markdown) <span class="text-red-500">*</span></label>
							<textarea
								id="markdown_content"
								name="markdown_content"
								rows="12"
								required
								class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm font-mono text-sm"
								placeholder="# Recipe Title

## Ingredients

- Ingredient 1
- Ingredient 2

## Instructions

1. Step one
2. Step two"
							/>
						</div>
					</div>
				</div>

				<div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row sm:items-center sm:justify-between">
					<div class="flex items-center">
						<input
							id="is_published"
							name="is_published"
							type="checkbox"
							class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500"
						/>
						<label for="is_published" class="ml-2 block text-sm text-gray-900">Publish this recipe</label>
					</div>
				</div>
			</div> 

			<div class="flex items-center justify-end gap-x-6 pt-5">
				<a href="/admin/recipes" class="text-sm font-medium text-gray-900 hover:text-orange-600">Cancel</a>
				<button
					type="button"
					id="extract-from-image-btn"
					class="inline-flex justify-center rounded-md border border-transparent bg-purple-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2"
				>
					ðŸ“¸ Extract from Image
				</button>
				<button
					type="submit"
					class="inline-flex justify-center rounded-md border border-transparent bg-orange-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2"
				>
					Create Recipe
				</button>
			</div>
		</form>
	</div>

	<script>
		const imageInput = document.getElementById('image_file');
		const imagePreview = document.getElementById('image_preview');
		const previewImg = document.getElementById('preview_img');
		const featuredImagePath = document.getElementById('featured_image_path');

		async function loadCategories() {
			try {
				const response = await fetch('http://localhost:8080/api/v1/categories');
				if (!response.ok) return;

				const categories = await response.json();
				const select = document.getElementById('category_id') as HTMLSelectElement;

				categories.forEach((cat: any) => {
					const option = document.createElement('option');
					option.value = cat.id;
					option.textContent = cat.name;
					select.appendChild(option);
				});
			} catch (error) {
				console.error('Failed to load categories:', error);
			}
		}

		async function loadGroups() {
			try {
				const response = await fetch('http://localhost:8080/api/v1/groups');
				if (!response.ok) return;

				const data = await response.json();
				const groups = data.groups || [];
				const select = document.getElementById('groups') as HTMLSelectElement;

				groups.forEach((group: any) => {
					const option = document.createElement('option');
					option.value = group.id;
					option.textContent = `${group.icon || 'ðŸ½ï¸'} ${group.name}`;
					select.appendChild(option);
				});
			} catch (error) {
				console.error('Failed to load groups:', error);
			}
		}

		loadCategories();
		loadGroups();

		imageInput.addEventListener('change', async (e) => {
			const file = (e.target as HTMLInputElement).files?.[0];
			if (!file) return;

			const formData = new FormData();
			formData.append('file', file);

			try {
				const response = await fetch('http://localhost:8080/api/v1/upload/image', {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
					},
					body: formData,
				});

				if (!response.ok) {
					const result = await response.json();
					throw new Error(result.error || 'Failed to upload image');
				}

				const result = await response.json();
				if (result.success) {
					featuredImagePath.value = result.url;
					previewImg.src = result.url;
					imagePreview.classList.remove('hidden');
				}
			} catch (error: any) {
				alert(error.message || 'Failed to upload image');
			}
		});

		document.getElementById('recipe-form').addEventListener('submit', async (e) => {
			e.preventDefault();
			const formData = new FormData(e.target);

			const groupsSelect = document.getElementById('groups') as HTMLSelectElement;
			const selectedGroups = Array.from(groupsSelect.selectedOptions).map(opt => opt.value);

			const data = {
				title: formData.get('title'),
				description: formData.get('description') || null,
				category_id: formData.get('category_id') ? parseInt(formData.get('category_id') as string) : null,
				servings: formData.get('servings') ? parseInt(formData.get('servings') as string) : null,
				prep_time_minutes: formData.get('prep_time_minutes') ? parseInt(formData.get('prep_time_minutes') as string) : null,
				cook_time_minutes: formData.get('cook_time_minutes') ? parseInt(formData.get('cook_time_minutes') as string) : null,
				difficulty: formData.get('difficulty') || null,
				featured_image_path: formData.get('featured_image_path') || null,
				markdown_content: formData.get('markdown_content'),
				is_published: formData.get('is_published') === 'on',
			};

			try {
				const response = await fetch('http://localhost:8080/api/v1/recipes', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
					},
					body: JSON.stringify(data),
				});

				if (!response.ok) {
					throw new Error('Failed to create recipe');
				}

				const result = await response.json();
				const recipeId = result.id;

				for (const groupId of selectedGroups) {
					await fetch(`http://localhost:8080/api/v1/groups/${groupId}/recipes`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
						},
						body: JSON.stringify({ recipe_id: recipeId }),
					});
				}

				window.location.href = '/admin/recipes';
			} catch (error: any) {
				alert(error.message);
			}
		});

		document.getElementById('extract-from-image-btn').addEventListener('click', async () => {
			const token = localStorage.getItem('accessToken');
			const imageFile = document.getElementById('image_file')?.files?.[0];

			if (!imageFile) {
				alert('Please upload an image first');
				return;
			}

			try {
				const response = await fetch('http://localhost:8080/api/v1/ai/extract?type=' + imageFile.type, {
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${token}`,
					},
					body: imageFile,
				});

				if (!response.ok) {
					const error = await response.json();
					if (error.error && error.error.includes('not enabled')) {
						alert('AI features are not enabled. Please configure AI settings.');
					} else {
						alert(error.error || 'Failed to extract recipe from image');
					}
					return;
				}

				const extracted = await response.json();
				const apply = confirm(
					`Recipe Extracted from Image!\n\n` +
					`Title: ${extracted.title}\n` +
					`Description: ${extracted.description || 'N/A'}\n\n` +
					`Apply these changes?`
				);

				if (apply) {
					document.getElementById('title').value = extracted.title || '';
					document.getElementById('description').value = extracted.description || '';
					document.getElementById('markdown_content').value = extracted.markdown_content || '';
					document.getElementById('prep_time_minutes').value = extracted.prep_time_minutes || '';
					document.getElementById('cook_time_minutes').value = extracted.cook_time_minutes || '';
					document.getElementById('servings').value = extracted.servings || '';
					document.getElementById('difficulty').value = extracted.difficulty || '';
				}
			} catch (error) {
				alert('Error extracting recipe from image');
				console.error(error);
			}
		});
	</script>
</AdminLayout>
