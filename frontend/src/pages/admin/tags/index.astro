---
import AdminLayout from '../../../layouts/AdminLayout.astro';
---

<AdminLayout title="Tags">
	<div class="sm:flex sm:items-center">
		<div class="sm:flex-auto">
			<h1 class="text-2xl font-semibold leading-6 text-gray-900">Tags</h1>
			<p class="mt-2 text-sm text-gray-700">
				Add tags to organize your recipes.
			</p>
		</div>
		<div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
			<a
				href="/admin/tags/new"
				class="block rounded-md bg-orange-600 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-orange-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-600"
			>
				Create Tag
			</a>
		</div>
	</div>

	<div id="loading" class="mt-8 text-center text-gray-500 py-12">
		Loading tags...
	</div>

	<div id="error" class="mt-8 hidden">
		<div class="bg-red-50 border border-red-200 rounded-md p-4">
			<p class="text-red-800" id="error-message"></p>
		</div>
	</div>

	<div id="tags-container" class="mt-8 hidden">
		<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
			<div id="tags-list">
			</div>
		</div>
	</div>

	<div id="empty-state" class="mt-8 hidden">
		<p class="text-center text-gray-500 py-12">
			No tags yet. <a href="/admin/tags/new" class="text-orange-600 hover:text-orange-700">Create your first tag!</a>
		</p>
	</div>
</AdminLayout>

<script>
	async function loadTags() {
		try {
			const response = await fetch('http://localhost:8080/api/v1/tags');
			if (!response.ok) {
				throw new Error('Failed to load tags');
			}
			const tags = await response.json();

			document.getElementById('loading').classList.add('hidden');

			if (tags.length === 0) {
				document.getElementById('empty-state').classList.remove('hidden');
				return;
			}

			const tagsList = document.getElementById('tags-list');
			tagsList.innerHTML = tags.map((tag: any) => `
				<div class="bg-white shadow-sm rounded-lg p-4 border-l-4" style="border-left-color: ${tag.color || '#6366f1'}">
					<div class="flex items-start justify-between">
						<div class="flex-1">
							<div class="flex items-center gap-2 mb-2">
								<span
									class="inline-block w-4 h-4 rounded-full"
									style="background-color: ${tag.color || '#6366f1'}"
								></span>
								<h3 class="text-lg font-medium text-gray-900">${tag.name}</h3>
							</div>
							<p class="text-sm text-gray-500">${tag.slug}</p>
						</div>
						<div class="flex items-center gap-2 ml-4">
							<a href="/admin/tags/edit?id=${tag.id}" class="text-orange-600 hover:text-orange-900 text-sm">Edit</a>
							<button onclick="deleteTag(${tag.id})" class="text-red-600 hover:text-red-900 text-sm">Delete</button>
						</div>
					</div>
				</div>
			`).join('');

			document.getElementById('tags-container').classList.remove('hidden');
		} catch (error: any) {
			document.getElementById('loading').classList.add('hidden');
			document.getElementById('error-message').textContent = error.message;
			document.getElementById('error').classList.remove('hidden');
		}
	}

	async function deleteTag(id: number) {
		if (!confirm('Are you sure you want to delete this tag?')) {
			return;
		}

		try {
			const response = await fetch(`http://localhost:8080/api/v1/tags/${id}`, {
				method: 'DELETE',
				headers: {
					'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
				},
			});

			if (!response.ok) {
				throw new Error('Failed to delete tag');
			}

			loadTags();
		} catch (error: any) {
			alert(error.message);
		}
	}

	(window as any).deleteTag = deleteTag;
	loadTags();
</script>
