---
import Layout from '../../layouts/Layout.astro';
import { marked } from 'marked';
---

<Layout title="Recipe">
	<div class="min-h-screen bg-gray-50">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
			<div id="loading" class="text-center text-gray-500 py-12">
				Loading recipe...
			</div>

			<div id="error" class="hidden">
				<div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
					<p class="text-red-800" id="error-message"></p>
				</div>
			</div>

			<div id="recipe-content" class="hidden">
				<div class="bg-white shadow-lg rounded-lg overflow-hidden">
					<div id="recipe-header" class="bg-orange-600 px-6 py-4">
						<h1 id="recipe-title" class="text-3xl font-bold text-white">Recipe Title</h1>
						<p id="recipe-description" class="text-orange-100 mt-1">Recipe description goes here</p>
					</div>

					<div id="recipe-image" class="hidden w-full">
						<img id="featured-image" src="" alt="Featured Image" class="w-full h-64 md:h-96 object-cover" />
					</div>

					<div class="px-6 py-6">
						<!-- Variations Tabs -->
						<div id="variations-tabs" class="mb-6 hidden">
							<div class="border-b border-gray-200">
								<nav class="-mb-px flex space-x-8" id="tabs-nav">
									<button data-tab="original" class="tab-btn border-orange-500 text-orange-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
										Original
									</button>
								</nav>
							</div>
						</div>

						<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
							<div class="bg-gray-50 p-4 rounded-lg text-center">
								<div class="text-2xl">üë•</div>
								<div class="text-sm text-gray-600">Servings</div>
								<div id="recipe-servings" class="font-semibold text-gray-900">4</div>
							</div>
							<div class="bg-gray-50 p-4 rounded-lg text-center">
								<div class="text-2xl">‚è±Ô∏è</div>
								<div class="text-sm text-gray-600">Prep Time</div>
								<div id="recipe-prep-time" class="font-semibold text-gray-900">10 min</div>
							</div>
							<div class="bg-gray-50 p-4 rounded-lg text-center">
								<div class="text-2xl">üç≥</div>
								<div class="text-sm text-gray-600">Cook Time</div>
								<div id="recipe-cook-time" class="font-semibold text-gray-900">20 min</div>
							</div>
							<div class="bg-gray-50 p-4 rounded-lg text-center">
								<div class="text-2xl">üìä</div>
								<div class="text-sm text-gray-600">Difficulty</div>
								<div id="recipe-difficulty" class="font-semibold text-gray-900">Easy</div>
							</div>
						</div>

						<div class="flex items-center gap-2 mb-6">
							<span id="recipe-category" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800 hidden">
								Recipe Category
							</span>
							<span id="recipe-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
								Published
							</span>
						</div>

						<!-- Variation Notes -->
						<div id="variation-notes" class="hidden mb-4 bg-blue-50 border border-blue-200 rounded-md p-4">
							<h3 class="font-medium text-blue-900 mb-1">üìù Variation Notes</h3>
							<p id="notes-content" class="text-blue-800 text-sm"></p>
						</div>

						<article id="recipe-markdown" class="prose prose-orange max-w-none">
						</article>
					</div>

					<!-- Create Variation Button (only for authenticated users) -->
					<div id="create-variation-container" class="px-6 pb-6 hidden">
						<a id="create-variation-btn" href="#" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
							‚ú® Create Variation
						</a>
					</div>
				</div>

				<div class="mt-6">
					<a href="/recipes" class="text-orange-600 hover:text-orange-700 font-medium">
						‚Üê Back to all recipes
					</a>
				</div>
			</div>
		</div>
	</div>

	<script>
		const urlParams = new URLSearchParams(window.location.search);
		const recipeId = urlParams.get('id');

		let recipeData = null;
		let variationsData = [];
		let currentTab = 'original';

		async function loadRecipe() {
			if (!recipeId) {
				showError('Recipe ID not provided');
				return;
			}

			try {
				const recipeResponse = await fetch(`http://localhost:8080/api/v1/recipes/${recipeId}`);
				if (!recipeResponse.ok) {
					throw new Error('Failed to load recipe');
				}
				recipeData = await recipeResponse.json();

				document.getElementById('recipe-title').textContent = recipeData.title;
				document.getElementById('recipe-description').textContent = recipeData.description || 'No description';

				displayRecipeData(recipeData, 'original');

				const categoryEl = document.getElementById('recipe-category');
				if (recipeData.category_name) {
					categoryEl.textContent = recipeData.category_name;
					categoryEl.classList.remove('hidden');
				}

				const statusEl = document.getElementById('recipe-status');
				statusEl.textContent = recipeData.is_published ? 'Published' : 'Draft';
				statusEl.className = recipeData.is_published
					? 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800'
					: 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';

				const recipeImage = document.getElementById('recipe-image');
				const featuredImage = document.getElementById('featured-image');
				if (recipeData.featured_image_path) {
					featuredImage.src = recipeData.featured_image_path;
					recipeImage.classList.remove('hidden');
				}

				document.getElementById('loading').classList.add('hidden');
				document.getElementById('recipe-content').classList.remove('hidden');

				await loadVariations();
				setupCreateVariationButton();
			} catch (error) {
				showError(error.message);
			}
		}

		async function loadVariations() {
			try {
				const response = await fetch(`http://localhost:8080/api/v1/recipes/${recipeId}/variations`);
				if (!response.ok) {
					return;
				}
				variationsData = await response.json();

				if (variationsData && variationsData.length > 0) {
					displayVariations();
				}
			} catch (error) {
				console.error('Failed to load variations:', error);
			}
		}

		function displayVariations() {
			const tabsNav = document.getElementById('tabs-nav');
			const variationsTabs = document.getElementById('variations-tabs');

			variationsData.forEach(variation => {
				const tab = document.createElement('button');
				tab.dataset.tab = variation.id;
				tab.className = 'tab-btn border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';

				const authorName = variation.author ? variation.author.email.split('@')[0] : 'Unknown';
				tab.innerHTML = `${authorName}`;

				tab.addEventListener('click', () => selectTab(variation.id));

				tabsNav.appendChild(tab);
			});

			variationsTabs.classList.remove('hidden');
		}

		function selectTab(tabId) {
			currentTab = tabId;

			const tabBtns = document.querySelectorAll('.tab-btn');
			tabBtns.forEach(btn => {
				if (btn.dataset.tab === tabId) {
					btn.classList.remove('border-transparent', 'text-gray-500');
					btn.classList.add('border-orange-500', 'text-orange-600');
				} else {
					btn.classList.remove('border-orange-500', 'text-orange-600');
					btn.classList.add('border-transparent', 'text-gray-500');
				}
			});

			if (tabId === 'original') {
				displayRecipeData(recipeData, 'original');
			} else {
				const variation = variationsData.find(v => v.id === tabId);
				if (variation) {
					displayRecipeData(variation, 'variation');
				}
			}
		}

		function displayRecipeData(data, type) {
			const servingsEl = document.getElementById('recipe-servings');
			const prepTimeEl = document.getElementById('recipe-prep-time');
			const cookTimeEl = document.getElementById('recipe-cook-time');
			const difficultyEl = document.getElementById('recipe-difficulty');
			const markdownEl = document.getElementById('recipe-markdown');
			const notesEl = document.getElementById('variation-notes');
			const notesContentEl = document.getElementById('notes-content');

			if (type === 'original') {
				servingsEl.textContent = recipeData.servings || 'N/A';
				prepTimeEl.textContent = recipeData.prep_time_minutes ? `${recipeData.prep_time_minutes} min` : 'N/A';
				cookTimeEl.textContent = recipeData.cook_time_minutes ? `${recipeData.cook_time_minutes} min` : 'N/A';
				difficultyEl.textContent = recipeData.difficulty || 'N/A';
				markdownEl.innerHTML = marked(recipeData.markdown_content);
				notesEl.classList.add('hidden');
			} else {
				servingsEl.textContent = data.servings || (recipeData.servings || 'N/A');
				prepTimeEl.textContent = data.prep_time_minutes ? `${data.prep_time_minutes} min` : (recipeData.prep_time_minutes ? `${recipeData.prep_time_minutes} min` : 'N/A');
				cookTimeEl.textContent = data.cook_time_minutes ? `${data.cook_time_minutes} min` : (recipeData.cook_time_minutes ? `${recipeData.cook_time_minutes} min` : 'N/A');
				difficultyEl.textContent = data.difficulty || (recipeData.difficulty || 'N/A');
				markdownEl.innerHTML = marked(data.markdown_content);

				if (data.notes) {
					notesContentEl.textContent = data.notes;
					notesEl.classList.remove('hidden');
				} else {
					notesEl.classList.add('hidden');
				}
			}
		}

		function setupCreateVariationButton() {
			const token = localStorage.getItem('accessToken');
			if (token) {
				const container = document.getElementById('create-variation-container');
				const btn = document.getElementById('create-variation-btn');
				container.classList.remove('hidden');
				btn.href = `/admin/recipes/variations/new?id=${recipeId}`;
			}
		}

		function showError(message) {
			document.getElementById('loading').classList.add('hidden');
			document.getElementById('error-message').textContent = message;
			document.getElementById('error').classList.remove('hidden');
		}

		loadRecipe();
	</script>
</Layout>
